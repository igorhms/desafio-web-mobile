<section class="dashboard">
  <header class="dashboard__header">
    <div class="dashboard__title">
      <p class="eyebrow">Monitoramento em tempo real</p>
      <h1>Dashboard inteligente</h1>
      <p class="subtitle">
        KPIs e gráficos alimentados por APIs públicas para apoiar decisões rápidas.
      </p>
      <div class="api-info">
        <mat-icon>cloud</mat-icon>
        <span>Fonte de dados: <strong>Open-Meteo API</strong></span>
      </div>
    </div>

    <app-theme-toggle />
  </header>

  <mat-card class="filters-card">
    <form class="filters-form" [formGroup]="filtersForm">
      <mat-form-field appearance="outline">
        <mat-label>Data inicial</mat-label>
        <input matInput [matDatepicker]="startPicker" formControlName="startDate" />
        <mat-datepicker-toggle matIconSuffix [for]="startPicker" />
        <mat-datepicker #startPicker />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Data final</mat-label>
        <input matInput [matDatepicker]="endPicker" formControlName="endDate" />
        <mat-datepicker-toggle matIconSuffix [for]="endPicker" />
        <mat-datepicker #endPicker />
        @if (filtersForm.controls.startDate.hasError('range')) {
        <mat-error>Data inicial deve ser menor que a final.</mat-error>
        }
      </mat-form-field>

      <button mat-flat-button color="primary" type="button" (click)="handleRetry()">
        Atualizar
      </button>
    </form>
  </mat-card>

  <section class="kpi-grid">
    @if (state().loading && !hasData()) {
    <div class="kpi-grid__skeleton" aria-label="Carregando KPIs">
      <mat-progress-spinner mode="indeterminate" diameter="48" />
    </div>
    } @else if (hasData()) {
    @for (kpi of kpis(); track kpi.id) {
    <app-kpi-card [kpi]="kpi" [unit]="state().dataset?.unit ?? ''" />
    }
    } @else if (state().error) {
    <div class="empty-state">
      <p>{{ state().error }}</p>
      <button mat-stroked-button color="primary" type="button" (click)="handleRetry()">
        Tentar novamente
      </button>
    </div>
    }
  </section>

  <mat-divider />

  <section class="charts-grid">
    @if (state().loading && hasData()) {
    <div class="charts-grid__overlay">
      <mat-progress-spinner mode="indeterminate" diameter="56" />
    </div>
    }

    @if (lineChartOptions()) {
    <app-chart-card title="Série temporal" subtitle="Visão contínua dos valores coletados"
      [options]="lineChartOptions()!" />
    }

    @if (barChartOptions()) {
    <app-chart-card title="Agregação diária" subtitle="Médias diárias para detectar padrões"
      [options]="barChartOptions()!" />
    }
  </section>

  <footer class="dashboard__footer" *ngIf="state().lastUpdated">
    Atualizado em {{ state().lastUpdated | date : 'dd/MM/yyyy HH:mm' }}
  </footer>
</section>