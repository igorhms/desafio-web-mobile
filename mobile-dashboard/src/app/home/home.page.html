<ion-header [translucent]="true">
  <ion-toolbar color="dark">
    <ion-title>Dashboard Mobile</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="applyFilters()">
        <ion-icon slot="icon-only" name="refresh-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content pullingIcon="chevron-down-outline"></ion-refresher-content>
  </ion-refresher>

  <ion-progress-bar *ngIf="state().loading" type="indeterminate"></ion-progress-bar>

  <ion-card class="api-info-card">
    <ion-card-content>
      <ion-icon name="cloud-outline"></ion-icon>
      <span>Fonte de dados: <strong>Open-Meteo API</strong></span>
    </ion-card-content>
  </ion-card>

  <section class="filters-card" [formGroup]="filtersForm">
    <h2>Filtros</h2>
    
    <ion-item lines="none" button="true" (click)="openStartDatePicker()">
      <ion-label position="stacked">Data inicial</ion-label>
      <ion-input
        [value]="formatDate(filtersForm.get('startDate')?.value)"
        readonly
        placeholder="Selecione a data inicial"
      ></ion-input>
      <ion-icon name="calendar-outline" slot="end"></ion-icon>
    </ion-item>

    <ion-item lines="none" button="true" (click)="openEndDatePicker()">
      <ion-label position="stacked">Data final</ion-label>
      <ion-input
        [value]="formatDate(filtersForm.get('endDate')?.value)"
        readonly
        placeholder="Selecione a data final"
      ></ion-input>
      <ion-icon name="calendar-outline" slot="end"></ion-icon>
    </ion-item>

    <ion-button expand="block" color="primary" (click)="applyFilters()">
      Aplicar filtros
    </ion-button>
  </section>

  <!-- Modal para Data Inicial -->
  <ion-modal [isOpen]="isStartDatePickerOpen" (willDismiss)="closeStartDatePicker($event)">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Selecionar Data Inicial</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeStartDatePicker()">Fechar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <ion-datetime
          presentation="date"
          [value]="formatDateForPicker(filtersForm.get('startDate')?.value)"
          (ionChange)="onStartDateChange($event)"
          [max]="formatDateForPicker(filtersForm.get('endDate')?.value)"
          locale="pt-BR"
        ></ion-datetime>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Modal para Data Final -->
  <ion-modal [isOpen]="isEndDatePickerOpen" (willDismiss)="closeEndDatePicker($event)">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Selecionar Data Final</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeEndDatePicker()">Fechar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <ion-datetime
          presentation="date"
          [value]="formatDateForPicker(filtersForm.get('endDate')?.value)"
          (ionChange)="onEndDateChange($event)"
          [min]="formatDateForPicker(filtersForm.get('startDate')?.value)"
          locale="pt-BR"
        ></ion-datetime>
      </ion-content>
    </ng-template>
  </ion-modal>

  <ion-card *ngIf="state().cacheMessage" class="info-card" color="tertiary">
    <ion-card-content>
      <ion-icon name="cloud-offline-outline"></ion-icon>
      {{ state().cacheMessage }}
    </ion-card-content>
  </ion-card>

  <section class="kpi-grid" *ngIf="hasData(); else emptyState">
    <ion-card *ngFor="let kpi of kpis()" class="kpi-card">
      <ion-card-header>
        <ion-card-subtitle>{{ kpi.label }}</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <div class="kpi-value">
          {{ kpi.value | number : '1.0-2':'pt' }}
          <small>{{ state().dataset?.unit }}</small>
        </div>
        <p class="kpi-helper" *ngIf="kpi.helperText">{{ kpi.helperText }}</p>
      </ion-card-content>
    </ion-card>
  </section>

  <ng-template #emptyState>
    <ion-card class="info-card" *ngIf="state().error">
      <ion-card-content>
        <p>{{ state().error }}</p>
        <ion-button expand="block" fill="outline" (click)="applyFilters()">
          Tentar novamente
        </ion-button>
      </ion-card-content>
    </ion-card>
  </ng-template>

  <section class="charts" *ngIf="hasData()">
    <ion-card *ngIf="lineChartOptions()" class="chart-card">
      <ion-card-header>
        <ion-card-title>Série temporal</ion-card-title>
        <ion-card-subtitle>Monitoramento contínuo</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <div echarts [options]="lineChartOptions()!" class="chart"></div>
      </ion-card-content>
    </ion-card>

    <ion-card *ngIf="barChartOptions()" class="chart-card">
      <ion-card-header>
        <ion-card-title>Médias diárias</ion-card-title>
        <ion-card-subtitle>Detecção de picos</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <div echarts [options]="barChartOptions()!" class="chart"></div>
      </ion-card-content>
    </ion-card>
  </section>
</ion-content>
